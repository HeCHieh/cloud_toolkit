name: Build All Platforms

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  analyze-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.1"
          channel: "stable"
          cache: true
      - name: Install dependencies
        run: flutter pub get
      - name: Generate code
        run: flutter pub run build_runner build --delete-conflicting-outputs
      - name: Check formatting
        run: dart format --set-exit-if-changed lib/
      - name: Run linter
        run: flutter analyze lib/
      - name: Run tests
        run: flutter test --coverage

  build-windows:
    needs: analyze-and-test
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.1"
          channel: "stable"
      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop
      - name: Install dependencies
        run: flutter pub get
      - name: Generate code
        run: flutter pub run build_runner build --delete-conflicting-outputs
      - name: Build Windows release
        run: flutter build windows --release
      - name: Install Inno Setup
        run: choco install innosetup -y --no-progress
      - name: Create Windows installer
        run: iscc .github/workflows/windows-installer.iss
      - uses: actions/upload-artifact@v4
        with:
          name: cloud-toolkit-windows-installer
          path: Output/*.exe
          compression-level: 0
      - uses: actions/upload-artifact@v4
        with:
          name: cloud-toolkit-windows-build
          path: build/windows/runner/Release/

  build-linux:
    needs: analyze-and-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.1"
          channel: "stable"
      - name: Enable Linux desktop
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libnotify-dev
          flutter config --enable-linux-desktop
      - name: Install dependencies
        run: flutter pub get
      - name: Generate code
        run: flutter pub run build_runner build --delete-conflicting-outputs
      - name: Build Linux release
        run: flutter build linux --release
      - name: Create DEB package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if ! [[ "$VERSION" =~ ^[0-9] ]]; then
            VERSION="0.0.0-${GITHUB_RUN_NUMBER}"
          fi
          mkdir -p cloud-toolkit-deb/usr/local/bin cloud-toolkit-deb/usr/share/applications cloud-toolkit-deb/DEBIAN
          cp -r build/linux/x64/release/bundle/* cloud-toolkit-deb/usr/local/bin/
      - name: Create desktop entry file
        run: |
          printf '[Desktop Entry]\nName=Cloud Toolkit\nComment=SSH deployment tool\nExec=cloud_toolkit\nIcon=cloud_toolkit\nTerminal=false\nType=Application\nCategories=Development;Utility;\n' > cloud-toolkit-deb/usr/share/applications/cloud-toolkit.desktop
      - name: Create DEB control file and build
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if ! [[ "$VERSION" =~ ^[0-9] ]]; then
            VERSION="0.0.0-${GITHUB_RUN_NUMBER}"
          fi
          printf 'Package: cloud-toolkit\nVersion: %s\nSection: utils\nPriority: optional\nArchitecture: amd64\nDepends: libgtk-3-0, libblkid1, liblzma5\nMaintainer: Cloud Toolkit <support@cloudtoolkit.dev>\nDescription: SSH deployment tool\n' "$VERSION" > cloud-toolkit-deb/DEBIAN/control
          dpkg-deb --build cloud-toolkit-deb cloud-toolkit-$VERSION-amd64.deb
      - uses: actions/upload-artifact@v4
        with:
          name: cloud-toolkit-linux-deb
          path: cloud-toolkit-*.deb
      - uses: actions/upload-artifact@v4
        with:
          name: cloud-toolkit-linux-build
          path: build/linux/x64/release/bundle/

  build-macos:
    needs: analyze-and-test
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.1"
          channel: "stable"
      - name: Enable macOS desktop
        run: flutter config --enable-macos-desktop
      - name: Install dependencies
        run: flutter pub get
      - name: Generate code
        run: flutter pub run build_runner build --delete-conflicting-outputs
      - name: Build macOS release
        run: flutter build macos --release
      - name: Create DMG
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          [ -z "$VERSION" ] && VERSION="1.0.0"
          cp -r build/macos/Build/Products/Release/cloud_toolkit.app CloudToolkit.app
          brew install create-dmg 2>/dev/null || true
          create-dmg "cloud-toolkit-macos-$VERSION.dmg" CloudToolkit.app
      - uses: actions/upload-artifact@v4
        with:
          name: cloud-toolkit-macos-dmg
          path: cloud-toolkit-*.dmg
      - uses: actions/upload-artifact@v4
        with:
          name: cloud-toolkit-macos-build
          path: build/macos/Build/Products/Release/

  create-release:
    needs: [build-windows, build-linux, build-macos]
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          cp artifacts/cloud-toolkit-windows-installer/*.exe release-assets/ 2>/dev/null || true
          cp artifacts/cloud-toolkit-linux-deb/*.deb release-assets/ 2>/dev/null || true
          cp artifacts/cloud-toolkit-macos-dmg/*.dmg release-assets/ 2>/dev/null || true
      - uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          body: |
            ## Installation

            ### Windows
            Download `cloud-toolkit-windows-*.exe` and run the installer

            ### macOS
            Download `cloud-toolkit-macos-*.dmg` and mount the disk image

            ### Linux
            Download `cloud-toolkit-*-amd64.deb` and install:
            ```bash
            sudo apt install ./cloud-toolkit-*.deb
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
